var force=0;var loadchatForce=function(){force=1;loadchat()};var loadchat=function(){var highVisit=0;var isHome=window.location.href;var tipDiv=document.getElementById("invitefortips");if(highVisit==1&&force==0){if(tipDiv!=null){tipDiv.innerHTML="<div style='padding-top:2px;font-size:12px;'>访问高峰，点击加载在线交流</div>"}return}else{if(tipDiv!=null){tipDiv.innerHTML="<a style='color:white;font-size:15px;' href='./friendsNewAddManager.html'>邀请伙伴们加入学者网</a>"}}var vals=getQueryString("Entry");if(vals!=null&&vals!=undefined&&vals.length>1){return}if(ACCOUNT_ID==null||ACCOUNT_ID==""||CHINESE_NAME==null||CHINESE_NAME==""){tipsbox.msg("加载交流系统错误","请重新刷新页面!");return}var friendroot=new Ext.tree.AsyncTreeNode({text:"学者好友"});var frpnl_hei=0;frpnl_hei=300;if(Ext.isIE7){frpnl_hei=246;MAIN_TOP_MARGIN=41}var friendpanel=new Ext.tree.TreePanel({root:friendroot,id:"friendtree",rootVisible:false,lines:false,enableDD:false,animate:true,height:frpnl_hei,loader:new Ext.tree.TreeLoader({dataUrl:"./FriendTreeActionForChat.html?acc_id="+ACCOUNT_ID}),title:"学者好友",listeners:{expandnode:function(node){treerefresh(friendpanel,"friend")}},autoScroll:true,border:true,iconCls:"user",bodyStyle:"background-color:#fff"});var recentroot=new Ext.tree.AsyncTreeNode({text:"最近联系"});var recentpanel=new Ext.tree.TreePanel({root:recentroot,id:"recenttree",rootVisible:false,lines:false,enableDD:false,animate:true,loader:new Ext.tree.TreeLoader({dataUrl:"./RecentTreeActionForChat.html?acc_id="+ACCOUNT_ID}),title:"最近联系",listeners:{expandnode:function(node){treerefresh(recentpanel,"recent")}},autoScroll:true,border:true,iconCls:"user-recent",bodyStyle:"background-color:#fff"});var recentroot=new Ext.tree.AsyncTreeNode({text:"团队交流"});var teampanel=new Ext.tree.TreePanel({root:recentroot,id:"teamtree",rootVisible:false,lines:false,enableDD:false,animate:true,loader:new Ext.tree.TreeLoader({dataUrl:"./TeamTreeActionForChat.html?acc_id="+ACCOUNT_ID}),title:"团队交流",listeners:{expandnode:function(node){teamrefresh()}},autoScroll:true,border:true,iconCls:"user-green",bodyStyle:"background-color:#fff"});var spAddChild=function(node){var nodes=searchpanel.root.childNodes;var i=0;for(;i<nodes.length;i++){if(node.text==nodes[i].text){break}}if(i==nodes.length){var nd=new Ext.tree.TreeNode(node);searchpanel.root.appendChild(nd)}};function isExistFunction(funcName){try{if(typeof(eval(funcName))=="function"){return true}}catch(e){}return false}function hasChinese(str){if(/.*[\u4e00-\u9fa5]+.*$/.test(str)){return true}else{return false}}var searchuserclick=function(node,e){LAST_SEND_TIME=0;var wcp=Ext.getCmp("tu"+node.id);if(!wcp){if(node.id=="addfriend"){}else{showsendwin(node.id,"")}}else{wcp.show()}Ext.getCmp("searchtextfield").setValue("");searchpanel.collapse();searchpanel.hide();friendpanel.expand()};var searchDelay=function(){searchpanel.root.removeAll();var inputText=Ext.getCmp("searchtextfield").getValue();var hasCh=hasChinese(inputText);var pyiArrText;if(isExistFunction("makePy")){if(hasCh){pyiArrText=new Array(inputText)}else{pyiArrText=makePy(inputText)}}else{pyiArrText=new Array(inputText)}var pyText=inputText;if(pyText==""){searchpanel.collapse();searchpanel.hide();friendpanel.expand();return}var nodes=friendpanel.root.childNodes;for(m=0;m<pyiArrText.length;m++){var text=pyiArrText[m].toLowerCase();for(var i=0;i<nodes.length;i++){var node=nodes[i];var name=node.text;var arrResult;if(isExistFunction("makePy")){if(hasCh){arrResult=new Array(name)}else{arrResult=makePy(name)}}else{arrResult=new Array(name)}for(n=0;n<arrResult.length;n++){if(text.Trim().length<=arrResult[n].length){if(text.Trim()!=""){var index=arrResult[n].toLowerCase().lastIndexOf(text.Trim());if(index>=0){spAddChild(node)}}}else{var tmpText=text.Trim().substr(0,arrResult[n].length);if(tmpText!=""&&arrResult[n].toLowerCase()==tmpText.toLowerCase()){spAddChild(node)}}}var pyResult=name;if(pyText.Trim().length<=pyResult.length){if(pyText.Trim()!=""){var index=pyResult.toLowerCase().lastIndexOf(pyText.Trim().toLowerCase());if(index>=0){spAddChild(node)}}}else{var tmpText=pyText.Trim().substr(0,pyResult.length);if(tmpText!=""&&pyResult.toLowerCase()==tmpText.toLowerCase()){spAddChild(node)}}}}var scount=searchpanel.root.childNodes.length;if(scount<=0){var node=new Ext.tree.TreeNode({text:"搜索学者并添加...",id:"addfriend",icon:"./chatjs/icons/searchicon.png"});node.setHref("http://www.scholat.com/portalsitesearch_scholarindex.html","_blank");searchpanel.setTitle("无本地搜索结果");searchpanel.root.appendChild(node)}else{searchpanel.setTitle("搜索结果["+scount+"]")}searchpanel.show();searchpanel.expand();friendpanel.collapse()};var searchTextChange=function(){var task=new Ext.util.DelayedTask(searchDelay);task.delay(200)};var tbar=new Ext.Toolbar({style:"height:18px;",items:[new Ext.form.TextField({name:"textfield",id:"searchtextfield",width:MAINWIDTH,enableKeyEvents:true,emptyText:"搜索学者好友",style:{marginLeft:"-2px",fontSize:"14px",background:"#ffffff url(./chatjs/icons/searchicon.png) no-repeat right center",paddingRight:"20px"},listeners:{keyup:searchTextChange}})]});var collbar=new Ext.Toolbar({style:"width:220px;height:30px;background-color:#399;",id:"collbardiv"});var searchroot=new Ext.tree.AsyncTreeNode({text:"search"});var searchpanel=new Ext.tree.TreePanel({root:searchroot,id:"searchtree",rootVisible:false,lines:false,enableDD:false,collapsed:true,title:"搜索结果",animate:true,loader:new Ext.tree.TreeLoader({}),autoScroll:true,border:true,iconCls:"user",style:"margin-top: 0px;",bodyStyle:"background-color:#fff"});var treerefresh=function(pnl,type){var cnds=pnl.root.childNodes;var nd;var url;if(type=="friend"){FRIEND_ONLINE_COUNT=0;FRIEND_COUNT=cnds.length}else{RECENT_ONLINE_COUNT=0;RECENT_COUNT=cnds.length}for(var i=0;i<cnds.length;i++){nd=cnds[i];if(nd.attributes.ol=="o"){url=nd.attributes.url;if(url==""||url==null||url=="url"||url.indexOf("/images/default.png")>-1){url="/chatjs/icons/online-avatar.jpg"}nd.getUI().getIconEl().src=WEB_ROOT+url;if(type=="friend"){FRIEND_ONLINE_COUNT++}else{RECENT_ONLINE_COUNT++}}}if(type=="friend"){Ext.getCmp("mainwin").setTitle(getmaintitle(ONLINE_TYPE,FRIEND_ONLINE_COUNT));if(FRIEND_COUNT>0){Ext.getCmp("friendtree").setTitle("学者好友 ["+FRIEND_ONLINE_COUNT+"/"+cnds.length+"]")}else{Ext.getCmp("friendtree").setTitle("好友列表")}}else{if(RECENT_COUNT>0){Ext.getCmp("recenttree").setTitle("最近联系 ["+RECENT_ONLINE_COUNT+"/"+RECENT_COUNT+"]")}else{Ext.getCmp("recenttree").setTitle("暂无最近联系人")}}};var teamrefresh=function(){var cnds=teampanel.root.childNodes;var nd;for(var i=0;i<cnds.length;i++){nd=cnds[i];nd.setTooltip(nd.text);if(navigator.userAgent.toUpperCase().indexOf("FIREFOX")>-1){nd.setText("<div style='font-size:15px;margin-top:-28px;float:right;width:190px;display:block;word-break: keep-all; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;' title='"+nd.text+"' >"+nd.text+"</div>")}else{nd.setText("<div style='font-size:15px;float:right;width:190px;display:block;word-break: keep-all; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;' title='"+nd.text+"' >"+nd.text+"</div>")}nd.getUI().getIconEl().src="./chatjs/icons/team.png"}if(cnds.length>0){Ext.getCmp("teamtree").setTitle("我的团队 ["+cnds.length+"]")}else{Ext.getCmp("teamtree").setTitle("暂无加入的团队")}};mainhei=window.innerHeight-MAIN_TOP_MARGIN;var bottombarstyle="margin-left:4px;margin-top:6px;margin-bottom:4px;height:22px;color:#fff";if(Ext.isIE7){bottombarstyle="margin-left:4px;margin-top:4px;margin-bottom:3px;height:18px;color:#fff"}var mainwin=new Ext.Window({id:"mainwin",title:getmaintitle(ONLINE_TYPE,FRIEND_ONLINE_COUNT),collapsible:true,collapsed:true,shadow:false,expandOnShow:false,minimizable:false,height:mainhei,width:MAINWIDTH,frame:true,closable:false,shim:false,animCollapse:true,style:"position:fixed;border:1px solid #aaa",constrainHeader:true,titleCollapse:true,resizable:false,layout:"accordion",border:false,draggable:false,iconCls:"main",listeners:{beforeclose:function(){CHAT_LOGIN=false;if(BUBBLE_WIN!=""&&BUBBLE_WIN!=undefined&&BUBBLE_WIN!=null){BUBBLE_WIN.remove();BUBBLE_WIN=""}var cwcmp;for(var i=0;i<CHAT_WIN_ARR.length;i++){cwcmp=Ext.getCmp(CHAT_WIN_ARR[i]);if(cwcmp){cwcmp.close()}}mainwin.destroy()},activate:function(){backtitle();closeemohiswin()},show:function(){searchpanel.hide()},expand:function(){mainColl=false;mainhei=window.innerHeight-MAIN_TOP_MARGIN;Ext.getCmp("mainwin").setHeight(mainhei);Ext.getCmp("mainwin").anchorTo(document,"tr-tr",[MAIN_LEFT_MARGIN,MAIN_TOP_MARGIN],false,true);if(Ext.isIE7&&Ext.getCmp("winbbar").hidden){setTimeout("showbbar()",250)}},collapse:function(){mainColl=true;Ext.getCmp("mainwin").anchorTo(document,"tr-br",[MAIN_LEFT_MARGIN+COLL_WIDTH,0-31],false,true);var arr=document.getElementsByClassName("x-window");for(var i=0;i<arr.length;i++){if(arr[i].id!="mainwin"){var wcp=Ext.getCmp(arr[i].id);wcp.hide()}}}},items:[searchpanel,friendpanel,recentpanel,teampanel],tbar:tbar,bbar:[{id:"winbbar",text:"在线",style:bottombarstyle,iconCls:"online",menu:new Ext.menu.Menu({items:[{text:"在线",style:"height:22px;background-color:#cff",iconCls:"online",handler:function(){setstate(1);ChatMng.serverstate(ACCOUNT_ID,ICON_URL,ONLINE_TYPE)}},{text:"隐身",iconCls:"invisible",style:"background-color:#cff",handler:function(){setstate(2);ChatMng.serverstate(ACCOUNT_ID,ICON_URL,ONLINE_TYPE)}}]})},"->",collbar],updateNode:function(id,ol,url){var i=0;var tnd;var nd=friendpanel.getNodeById(id);var rnd=recentpanel.getNodeById(id);var cnds=friendpanel.root.childNodes;var rnds=recentpanel.root.childNodes;var leafico="./ext-2.0.2/resources/images/default/tree/leaf.gif";if(url.indexOf("null")>-1||url==WEB_ROOT||url==""){url=WEB_ROOT+"/chatjs/icons/online-avatar.jpg"}if(nd&&nd.attributes.ol!=ol){if(ol=="o"){FRIEND_ONLINE_COUNT++;Ext.getCmp("friendtree").setTitle("学者好友 ["+FRIEND_ONLINE_COUNT+"/"+cnds.length+"]");Ext.getCmp("mainwin").setTitle(getmaintitle(ONLINE_TYPE,FRIEND_ONLINE_COUNT));if(rnd){RECENT_ONLINE_COUNT++;Ext.getCmp("recenttree").setTitle("最近联系 ["+RECENT_ONLINE_COUNT+"/"+rnds.length+"]");rnd.getUI().getIconEl().src=url;rnd.attributes.ol="o"}for(i=0;i<cnds.length;i++){tnd=cnds[i];if(tnd.attributes.ol=="f"){if(tnd.id==id){tnd.attributes.ol="o";tnd.getUI().getIconEl().src=url;return}else{var tmptext=tnd.text;var tmpid=tnd.id;tnd.setId("newtmpnode");tnd.setText(nd.text);tnd.attributes.ol="o";nd.setId("oldtmpnode");nd.setText(tmptext);tnd.setId(id);nd.setId(tmpid);nd.getUI().getIconEl().src=leafico;tnd.getUI().getIconEl().src=url;return}}}}else{FRIEND_ONLINE_COUNT--;Ext.getCmp("friendtree").setTitle("学者好友 ["+FRIEND_ONLINE_COUNT+"/"+cnds.length+"]");Ext.getCmp("mainwin").setTitle(getmaintitle(ONLINE_TYPE,FRIEND_ONLINE_COUNT));if(rnd){RECENT_ONLINE_COUNT--;if(RECENT_ONLINE_COUNT<0){RECENT_ONLINE_COUNT=0;Ext.getCmp("recenttree").setTitle("暂无最近联系人")}else{Ext.getCmp("recenttree").setTitle("最近联系 ["+RECENT_ONLINE_COUNT+"/"+rnds.length+"]")}rnd.getUI().getIconEl().src=leafico;rnd.attributes.ol="f"}for(i=cnds.length-1;i>-1;i--){tnd=cnds[i];if(tnd.attributes.ol=="o"){if(tnd.id==id){tnd.attributes.ol="f";tnd.getUI().getIconEl().src=leafico;return}else{var tmptext=tnd.text;var tmpid=tnd.id;var tmpurl=tnd.getUI().getIconEl().src;tnd.setId("newtmpnode");tnd.setText(nd.text);tnd.attributes.ol="f";tnd.getUI().getIconEl().src=leafico;nd.setId("oldtmpnode");nd.setText(tmptext);nd.getUI().getIconEl().src=tmpurl;tnd.setId(id);nd.setId(tmpid);return}}}}}},getChnById:function(id){var cnds=friendpanel.root.childNodes;var chn="...";if(id==ACCOUNT_ID){return CHINESE_NAME}for(i=cnds.length-1;i>-1;i--){tnd=cnds[i];if(tnd.id==id){chn=tnd.text;return chn}}return"..."},updateList:function(){friendpanel.root.reload();recentpanel.root.reload()},updateRecent:function(){recentpanel.root.reload()},getFrdNode:function(id){return friendpanel.getNodeById(id)},checkmemExist:function(id){var cnds=teampanel.root.childNodes;var nd;var wcp;for(var i=0;i<cnds.length;i++){nd=cnds[i];wcp=Ext.getCmp("tt"+nd.id);if(wcp){if(wcp.getMemNode(id)){wcp.updateMem();break}}}},layoutConfig:{animate:true}});mainwin.show();var userclick=function(node,e){LAST_SEND_TIME=0;var wcp=Ext.getCmp("tu"+node.id);if(!wcp){showsendwin(node.id,"")}else{wcp.showDlg()}setSliderbarTitle(node.id,false)};var teamclick=function(node,e){LAST_SEND_TIME=0;var wcp=Ext.getCmp("tt"+node.id);if(!wcp){new SendTeamMsgWin(node.id,node.attributes.name,"",node.attributes.ol)}else{wcp.showDlg()}setSliderbarTitle(node.id,false)};searchpanel.on("click",searchuserclick);friendpanel.on("click",userclick);recentpanel.on("click",userclick);teampanel.on("click",teamclick);Ext.TaskMgr.start.defer(2000,this,[checktask]);if(!Ext.isIE){MAIN_LEFT_MARGIN=-18;if(isMacOS()){MAIN_LEFT_MARGIN=0}}if(Ext.isIE7){Ext.getCmp("winbbar").hide()}if(isEdge()){MAIN_LEFT_MARGIN=-13}Ext.getCmp("mainwin").focus("",250);Ext.getCmp("mainwin").anchorTo(document,"tr-br",[MAIN_LEFT_MARGIN+COLL_WIDTH,0-31],false,true);setTimeout("showfile()",3000);CHAT_WIN_ARR[CHAT_WIN_ARR.length]="fsharewin";setstatemenu(ONLINE_TYPE);window.onresize=function(){mainhei=window.innerHeight-MAIN_TOP_MARGIN;Ext.getCmp("mainwin").setHeight(mainhei)};var bObj=document.getElementById("collbardiv");bObj.onclick=objclick;function objclick(){Ext.getCmp("mainwin").anchorTo(document,"tr-br",[MAIN_LEFT_MARGIN+COLL_WIDTH,0-31],false,true);Ext.getCmp("mainwin").collapse()}};
var uploadIndex=null;function showFileSend(a){uploadIndex=layer.open({type:1,title:"发送文件给 ["+SEND_FILE_NAME+"]",skin:"layui-layer-molv",closeBtn:1,moveType:1,offset:[$("#"+a.win_id).offset().top+100,$("#"+a.win_id).offset().left+30],area:["340px","200px"],content:"<div class='pekecontainer' id='container' style='width: 330px; height: 60px;'><ul></ul><div id='original' class='pekerow pkrw' style='padding-left: 10px;'><div class='pekeitem_preview'></div><div class='file' style='padding-bottom: 5px; padding-top: 30px;'><div class='progress-pekeupload'><div class='pkuppbr bar-pekeupload pekeup-progress-bar' style='min-width: 2em;width:0%'><span>0%</span></div></div></div></div></div><input id='selectFile' type='file' name='myUpload'>"});$("#selectFile").pekeUpload(a)}(function(a){a.fn.pekeUpload=function(c){var f=c.allowedExtensions.split("|");var b="";for(var d=0;d<f.length;d++){if(d==0){b+=f[d]}else{b+=", "+f[d]}}var g={dragMode:false,dragText:"拖拽上传",bootstrap:false,btnText:"上传文件",allowedExtensions:"",invalidExtError:"请上传有效的文件类型！您可以上传的文件类型为"+b+"。",maxSize:100,sizeError:"上传文件太大，已超过限制！",showPreview:true,showFilename:true,notAjax:false,showPercent:true,showErrorAlerts:true,errorOnResponse:"文件上传失败",onSubmit:false,url:"",data:null,limit:1,limitError:"上传文件数超过限制！",delfiletext:"删除",onFileError:function(i,h){},onFileSuccess:function(h,i){}};var c=a.extend(g,c);var e={obj:a(this),files:[],uparea:null,container:null,uploadedfiles:0,hasErrors:false,init:function(){this.replacehtml();this.uparea.on("click",function(){e.selectfiles()});if(c.dragMode){this.handledragevents()}this.handlebuttonevents();if(c.onSubmit){this.handleFormSubmission()}},replacehtml:function(){var h=null;switch(c.dragMode){case true:switch(c.bootstrap){case true:h='<div class="well well-lg pkuparea pkdragarea" style="cursor:pointer"><h4>'+c.dragText+"</h4></div>";break;case false:h='<div class="pekeupload-drag-area pkuparea pkdragarea" style="cursor:pointer"><h4>'+c.dragText+"</h4></div>";break}break;case false:switch(c.bootstrap){case true:h='<a href="javascript:void(0)" style="text-decoration: none;"><div style="width: 340px; background: #E0E0E0; color: #000; margin-top: 20px; text-align: center; font-size:16px;">[点击选择1个文件，不大于100MB]</div></a>';break;case false:h='<a href="javascript:void(0)" style="text-decoration: none;"><div style="width: 340px; background: #E0E0E0; color: #000; margin-top: 20px; text-align: center; font-size:16px;">[点击选择1个文件，不大于100MB]</div></a>';break}break}this.obj.hide();this.uparea=a(h).insertAfter(this.obj);this.container=a("#container")},selectfiles:function(){this.obj.click()},handlebuttonevents:function(){a(document).on("change",this.obj.selector,function(){e.checkFile(e.obj[0].files[0])})},handledragevents:function(){a(document).on("dragenter",function(h){h.stopPropagation();h.preventDefault()});a(document).on("dragover",function(h){h.stopPropagation();h.preventDefault()});a(document).on("drop",function(h){h.stopPropagation();h.preventDefault()});this.uparea.on("dragenter",function(h){h.stopPropagation();h.preventDefault();a(this).css("border","2px solid #0B85A1")});this.uparea.on("dragover",function(h){h.stopPropagation();h.preventDefault()});this.uparea.on("drop",function(k){a(this).css("border","2px dotted #0B85A1");k.preventDefault();var j=k.originalEvent.dataTransfer.files;for(var h=0;h<j.length;h++){e.checkFile(j[h])}})},checkFile:function(h){error=this.validateFile(h);if(error){if(c.showErrorAlerts){this.addWarning(error)}this.hasErrors=true;c.onFileError(h,error)}else{this.files.push(h);if(this.files.length>c.limit&&c.limit>0){this.files.splice(this.files.length-1,1);if(c.showErrorAlerts){this.addWarning(c.limitError,this.obj)}this.hasErrors=true;c.onFileError(h,error)}else{this.addRow(h);if(c.onSubmit==false){this.upload(h,this.files.length-1)}}}},addWarning:function(h,i){layer.alert(h,{icon:5})},validateFile:function(h){if(!this.checkExtension(h)){return c.invalidExtError}if(!this.checkSize(h)){return c.sizeError}return null},checkExtension:function(h){if(c.allowedExtensions==""){return true}var i=h.name.split(".").pop().toLowerCase();var j=c.allowedExtensions.split("|");if(a.inArray(i,j)==-1){return false}else{return true}},checkSize:function(h){if(c.maxSize==0){return true}if(h.size>c.maxSize*1024*1024){return false}else{return true}},addRow:function(m){var l=this.files.length-1;switch(c.bootstrap){case true:var j=a('<div class="row pkrw" rel="'+l+'"></div>').appendTo(this.container);if(c.showPreview){var n=a('<div class="col-lg-2 col-md-2 col-xs-4"></div>').appendTo(j)}var k=a('<div class="col-lg-8 col-md-8 col-xs-8"></div>').appendTo(j);if(c.showFilename){k.append('<div class="filename">'+m.name+"</div>")}if(c.notAjax==false){var h=a('<div class="progress"><div class="pkuppbr progress-bar" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="min-width: 2em;"></div></div>').appendTo(k);if(c.showPercent){h.find("div.progress-bar").text("0%")}}break;case false:a("#original").hide();var j=a('<div class="pekerow pkrw" rel="'+l+'" style="padding-left: 10px;"></div>').appendTo(this.container);if(c.showPreview){var n=a('<div class="pekeitem_preview"></div>').appendTo(j)}var k=a('<div class="file" style="padding-bottom: 5px; padding-top: 30px;"></div>').appendTo(j);if(c.notAjax==false){var h=a('<div class="progress-pekeupload"><div class="pkuppbr bar-pekeupload pekeup-progress-bar" style="min-width: 2em;width:0%"><span></span></div></div>').appendTo(k);if(c.showPercent){h.find("div.bar-pekeupload").text("0%")}}break}},previewFile:function(i,j){var k=j.type.split("/")[0];switch(k){case"image":var h=window.URL.createObjectURL(j);var l=a('<img class="thumbnail" src="'+h+'" height="64" />').appendTo(i);break;case"video":var h=window.URL.createObjectURL(j);var l=a('<video src="'+h+'" width="100%" controls></video>').appendTo(i);break;case"audio":var h=window.URL.createObjectURL(j);var l=a('<audio src="'+h+'" width="100%" controls></audio>').appendTo(i);break;default:if(c.bootstrap){var l=a('<i class="glyphicon glyphicon-file"></i>').appendTo(i)}else{var l=a('<div class="pekeupload-item-file"></div>').appendTo(i)}break}},upload:function(i,k){var j=new FormData();j.append(this.obj.attr("name"),i);for(var h in c.data){j.append(h,c.data[h])}j.append("myUploadFileName",i.name);a.ajax({type:"post",url:c.url,data:j,dataType:"text",timeout:100000,cache:false,traditional:true,success:function(m){if(m!=null){e.files[k]=null;a('div.row[rel="'+k+'"]').find(".pkuppbr").css("width","100%");c.onFileSuccess(i,m);tipsbox.msg("文件发送成功","服务器将为您保存30天",5);ChatMng.sendfile(SEND_FILE_ACCID);setTimeout(function(){layer.close(uploadIndex)},500)}else{e.files.splice(k,1);var l=null;if(error in m){l=null}else{l=c.errorOnResponse}if(c.showErrorAlerts){e.addWarning(l,a('div.row[rel="'+k+'"]'))}a('div.row[rel="'+k+'"]').remove();e.hasErrors=true;c.onFileError(i,l)}},error:function(n,l,m){e.files.splice(k,1);if(c.showErrorAlerts){e.addWarning(m,a('div.pkrw[rel="'+k+'"]'))}e.hasErrors=true;c.onFileError(i,m);a('div.pkrw[rel="'+k+'"]').remove()},xhr:function(){myXhr=a.ajaxSettings.xhr();if(myXhr.upload){myXhr.upload.addEventListener("progress",function(l){e.handleProgress(l,k,i.name)},false)}return myXhr},complete:function(){if(c.onSubmit){e.uploadedfiles++;if(e.uploadedfiles==e.files.length&&e.hasErrors==false){e.obj.remove();e.obj.parent("form").submit()}}},cache:false,contentType:false,processData:false})},handleProgress:function(m,n,i){if(m.lengthComputable){if(i.length>10){i=i.substring(0,10)+"..."}var l=m.total;var j=m.loaded;var k=Number((m.loaded*100/m.total).toFixed(2));var h=a('div.pkrw[rel="'+n+'"]').find(".pkuppbr");h.css("width",k+"%");if(c.showPercent){h.text(i+" "+k+"%")}}},handleFormSubmission:function(){var h=this.obj.parent("form");h.submit(function(){e.hasErrors=false;e.uploadedfiles=0;for(var j=0;j<e.files.length;j++){if(e.files[j]){e.upload(e.files[j],j)}else{e.uploadedfiles++;if(e.uploadedfiles==e.files.length&&e.hasErrors==false){e.obj.remove();return true}}}return false})},delAndRearrange:function(h){var i=h.attr("rel");e.files.splice(parseInt(i),1);h.remove();e.container.find("div.pkrw").each(function(j){a(this).attr("rel",j)})}};e.init()}})(jQuery);
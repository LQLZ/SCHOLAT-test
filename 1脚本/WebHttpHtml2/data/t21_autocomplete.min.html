(function(a){a.fn.extend({autocomplete:function(b,c){var d=typeof b=="string";c=a.extend({},a.Autocompleter.defaults,{url:d?b:null,data:d?null:b,delay:d?a.Autocompleter.defaults.delay:10,max:c&&!c.scroll?10:150},c);c.highlight=c.highlight||function(e){return e};c.formatMatch=c.formatMatch||c.formatItem;return this.each(function(){new a.Autocompleter(this,c)})},result:function(b){return this.bind("result",b)},search:function(b){return this.trigger("search",[b])},flushCache:function(){return this.trigger("flushCache")},setOptions:function(b){return this.trigger("setOptions",[b])},unautocomplete:function(){return this.trigger("unautocomplete")}});a.Autocompleter=function(m,h){var c={UP:38,DOWN:40,DEL:46,TAB:9,RETURN:13,ESC:27,COMMA:188,PAGEUP:33,PAGEDOWN:34,BACKSPACE:8,SPACE:32};var b=a(m).attr("autocomplete","off").addClass(h.inputClass);var k;var r="";var n=a.Autocompleter.Cache(h);var e=0;var v;var y={mouseDownOnSelect:false};var s=a.Autocompleter.Select(h,m,d,y);var x;a.browser.opera&&a(m.form).bind("submit.autocomplete",function(){if(x){x=false;return false}});b.bind((a.browser.opera?"keypress":"keydown")+".autocomplete",function(z){v=z.keyCode;switch(z.keyCode){case c.UP:z.preventDefault();if(s.visible()){s.prev()}else{u(0,true)}break;case c.DOWN:z.preventDefault();if(s.visible()){s.next()}else{u(0,true)}break;case c.PAGEUP:z.preventDefault();if(s.visible()){s.pageUp()}else{u(0,true)}break;case c.PAGEDOWN:z.preventDefault();if(s.visible()){s.pageDown()}else{u(0,true)}break;case h.multiple&&a.trim(h.multipleSeparator)==","&&c.COMMA:case c.TAB:case c.RETURN:if(d()){z.preventDefault();x=true;return false}break;case c.ESC:s.hide();break;default:clearTimeout(k);k=setTimeout(u,h.delay);break}}).focus(function(){e++}).blur(function(){e=0;if(!y.mouseDownOnSelect){t()}}).click(function(){if(e++>1&&!s.visible()){u(0,true)}}).bind("search",function(){var z=(arguments.length>1)?arguments[1]:null;function A(E,D){var B;if(D&&D.length){for(var C=0;C<D.length;C++){if(D[C].result.toLowerCase()==E.toLowerCase()){B=D[C];break}}}if(typeof z=="function"){z(B)}else{b.trigger("result",B&&[B.data,B.value])}}a.each(i(b.val()),function(B,C){g(C,A,A)})}).bind("flushCache",function(){n.flush()}).bind("setOptions",function(){a.extend(h,arguments[1]);if("data" in arguments[1]){n.populate()}}).bind("unautocomplete",function(){s.unbind();b.unbind();a(m.form).unbind(".autocomplete")});var f="";function d(){if(b.val().lastIndexOf(" ")<0){f=""}var A=s.selected();if(!A){return false}var z=A.result;r=z;if(h.multiple){var B=i(b.val());if(B.length>1){z=B.slice(0,B.length-1).join(h.multipleSeparator)+h.multipleSeparator+z}z+=h.multipleSeparator}b.val(f+z+" ");f=b.val();w();b.trigger("result",[A.data,A.value]);return true}function u(C,B){if(v==c.DEL){s.hide();return}var A=b.val();var z=A.lastIndexOf(" ");A=A.substring(z+1);if(!B&&A==r){return}r=A;A=j(A);if(A.length>=h.minChars){b.addClass(h.loadingClass);if(!h.matchCase){A=A.toLowerCase()}g(A,l,w)}else{o();s.hide()}}function i(A){if(!A){return[""]}var B=A.split(h.multipleSeparator);var z=[];a.each(B,function(C,D){if(a.trim(D)){z[C]=a.trim(D)}});return z}function j(z){if(!h.multiple){return z}var A=i(z);return A[A.length-1]}function q(z,A){if(h.autoFill&&(j(b.val()).toLowerCase()==z.toLowerCase())&&v!=c.BACKSPACE){b.val(b.val()+A.substring(j(r).length));a.Autocompleter.Selection(m,r.length,r.length+A.length)}}function t(){clearTimeout(k);k=setTimeout(w,200)}function w(){var z=s.visible();s.hide();clearTimeout(k);o();if(h.mustMatch){b.search(function(A){if(!A){if(h.multiple){var B=i(b.val()).slice(0,-1);b.val(B.join(h.multipleSeparator)+(B.length?h.multipleSeparator:""))}else{b.val("")}}})}if(z){a.Autocompleter.Selection(m,m.value.length,m.value.length)}}function l(A,z){if(z&&z.length&&e){o();s.display(z,A);q(A,z[0].value);s.show()}else{w()}}function g(A,C,z){if(!h.matchCase){A=A.toLowerCase()}var B=n.load(A);if(B&&B.length){C(A,B)}else{if((typeof h.url=="string")&&(h.url.length>0)){var D={timestamp:+new Date()};a.each(h.extraParams,function(E,F){D[E]=typeof F=="function"?F():F});a.ajax({mode:"abort",port:"autocomplete"+m.name,dataType:h.dataType,url:h.url,data:a.extend({q:j(A),limit:h.max},D),success:function(F){var E=h.parse&&h.parse(F)||p(F);n.add(A,E);C(A,E)}})}else{s.emptyList();z(A)}}}function p(C){var z=[];var B=C.split("\n");for(var A=0;A<B.length;A++){var D=a.trim(B[A]);if(D){D=D.split("|");z[z.length]={data:D,value:D[0],result:h.formatResult&&h.formatResult(D,D[0])||D[0]}}}return z}function o(){b.removeClass(h.loadingClass)}};a.Autocompleter.defaults={inputClass:"ac_input",resultsClass:"ac_results",loadingClass:"ac_loading",minChars:1,delay:400,matchCase:false,matchSubset:true,matchContains:false,cacheLength:10,max:100,mustMatch:false,extraParams:{},selectFirst:true,formatItem:function(b){return b[0]},formatMatch:null,autoFill:false,width:0,multiple:false,multipleSeparator:", ",highlight:function(c,b){return c.replace(new RegExp("(?![^&;]+;)(?!<[^<>]*)("+b.replace(/([\^\$\(\)\[\]\{\}\*\.\+\?\|\\])/gi,"\\$1")+")(?![^<>]*>)(?![^&;]+;)","gi"),"<strong>$1</strong>")},scroll:true,scrollHeight:180};a.Autocompleter.Cache=function(c){var f={};var d=0;function h(l,k){if(!c.matchCase){l=l.toLowerCase()}var j=l.indexOf(k);if(j==-1){return false}return j==0||c.matchContains}function g(j,i){if(d>c.cacheLength){b()}if(!f[j]){d++}f[j]=i}function e(){if(!c.data){return false}var k={},j=0;if(!c.url){c.cacheLength=1}k[""]=[];for(var m=0,l=c.data.length;m<l;m++){var p=c.data[m];p=(typeof p=="string")?[p]:p;var o=c.formatMatch(p,m+1,c.data.length);if(o===false){continue}var n=o.charAt(0).toLowerCase();if(!k[n]){k[n]=[]}var q={value:o,data:p,result:c.formatResult&&c.formatResult(p)||o};k[n].push(q);if(j++<c.max){k[""].push(q)}}a.each(k,function(r,s){c.cacheLength++;g(r,s)})}setTimeout(e,25);function b(){f={};d=0}return{flush:b,add:g,populate:e,load:function(n){if(!c.cacheLength||!d){return null}if(!c.url&&c.matchContains){var m=[];for(var j in f){if(j.length>0){var o=f[j];a.each(o,function(p,k){if(h(k.value,n)){m.push(k)}})}}return m}else{if(f[n]){return f[n]}else{if(c.matchSubset){for(var l=n.length-1;l>=c.minChars;l--){var o=f[n.substr(0,l)];if(o){var m=[];a.each(o,function(p,k){if(h(k.value,n)){m[m.length]=k}});return m}}}}}return null}}};a.Autocompleter.Select=function(e,j,l,p){var i={ACTIVE:"ac_over"};var k,f=-1,r,m="",s=true,c,o;function n(){if(!s){return}c=a("<div/>").hide().addClass(e.resultsClass).css("position","absolute").appendTo(document.body);o=a("<ul/>").appendTo(c).mouseover(function(t){if(q(t).nodeName&&q(t).nodeName.toUpperCase()=="LI"){f=a("li",o).removeClass(i.ACTIVE).index(q(t));a(q(t)).addClass(i.ACTIVE)}}).click(function(t){a(q(t)).addClass(i.ACTIVE);l();j.focus();return false}).mousedown(function(){p.mouseDownOnSelect=true}).mouseup(function(){p.mouseDownOnSelect=false});if(e.width>0){c.css("width",e.width)}s=false}function q(u){var t=u.target;while(t&&t.tagName!="LI"){t=t.parentNode}if(!t){return[]}return t}function h(t){k.slice(f,f+1).removeClass(i.ACTIVE);g(t);var v=k.slice(f,f+1).addClass(i.ACTIVE);if(e.scroll){var u=0;k.slice(0,f).each(function(){u+=this.offsetHeight});if((u+v[0].offsetHeight-o.scrollTop())>o[0].clientHeight){o.scrollTop(u+v[0].offsetHeight-o.innerHeight())}else{if(u<o.scrollTop()){o.scrollTop(u)}}}}function g(t){f+=t;if(f<0){f=k.size()-1}else{if(f>=k.size()){f=0}}}function b(t){return e.max&&e.max<t?e.max:t}function d(){o.empty();var u=b(r.length);for(var v=0;v<u;v++){if(!r[v]){continue}var w=e.formatItem(r[v].data,v+1,u,r[v].value,m);if(w===false){continue}var t=a("<li/>").html(e.highlight(w,m)).addClass(v%2==0?"ac_even":"ac_odd").appendTo(o)[0];a.data(t,"ac_data",r[v])}k=o.find("li");if(e.selectFirst){k.slice(0,1).addClass(i.ACTIVE);f=0}if(a.fn.bgiframe){o.bgiframe()}}return{display:function(u,t){n();r=u;m=t;d()},next:function(){h(1)},prev:function(){h(-1)},pageUp:function(){if(f!=0&&f-8<0){h(-f)}else{h(-8)}},pageDown:function(){if(f!=k.size()-1&&f+8>k.size()){h(k.size()-1-f)}else{h(8)}},hide:function(){c&&c.hide();k&&k.removeClass(i.ACTIVE);f=-1},visible:function(){return c&&c.is(":visible")},current:function(){return this.visible()&&(k.filter("."+i.ACTIVE)[0]||e.selectFirst&&k[0])},show:function(){var v=a(j).offset();c.css({width:typeof e.width=="string"||e.width>0?e.width:a(j).width(),top:v.top+j.offsetHeight,left:v.left}).show();if(e.scroll){o.scrollTop(0);o.css({maxHeight:e.scrollHeight,overflow:"auto"});if(a.browser.msie&&typeof document.body.style.maxHeight==="undefined"){var t=0;k.each(function(){t+=this.offsetHeight});var u=t>e.scrollHeight;o.css("height",u?e.scrollHeight:t);if(!u){k.width(o.width()-parseInt(k.css("padding-left"))-parseInt(k.css("padding-right")))}}}},selected:function(){var t=k&&k.filter("."+i.ACTIVE).removeClass(i.ACTIVE);return t&&t.length&&a.data(t[0],"ac_data")},emptyList:function(){o&&o.empty()},unbind:function(){c&&c.remove()}}};a.Autocompleter.Selection=function(d,e,c){if(d.createTextRange){var b=d.createTextRange();b.collapse(true);b.moveStart("character",e);b.moveEnd("character",c);b.select()}else{if(d.setSelectionRange){d.setSelectionRange(e,c)}else{if(d.selectionStart){d.selectionStart=e;d.selectionEnd=c}}}d.focus()}})(jQuery);
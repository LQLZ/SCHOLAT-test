var sendMsgWin_arr=new Array();var sliderbarItems_arr=[];var newMsg_arr=new Array();var newTeamMsg_arr=[];var current_winid="";var doubleclicked="";var page_width=document.documentElement.clientWidth;var mm_hei=275;var send_wid=398;var mm_style="padding:4px 12px 6px 12px;";var his_hei=372;var snd_hei=450;if(Ext.isIE7){mm_hei=265;send_wid=400;mm_style="padding:4px 8px 6px 8px;";his_hei=362}if(Ext.isIE){snd_hei=440;mm_hei=265}if((Ext.isGecko||Ext.isGecko2||Ext.isGecko3)&&!isIE11()){his_hei=372}if(isIE11()){his_hei=362;snd_hei=450}function hasIdInSendMsgWinArr(b){if(typeof b=="string"){for(var a=0;a<sendMsgWin_arr.length;a++){if(sendMsgWin_arr[a]==b){return a}}return -1}else{return -1}}function deleteSendMsgWinId(b){var a=hasIdInSendMsgWinArr(b);if(a!=-1){sendMsgWin_arr.splice(a,1);return a}return -1}var winGroupMgr=new Ext.WindowGroup();winGroupMgr.zseed=9999;var exPang=function(){Ext.getCmp("mainwin").expand()};var sliderbar=new Ext.Window({id:"sliderbar",header:false,x:page_width-330-send_wid,y:31,width:150,height:snd_hei,style:"position:fixed;border:0px solid #aaa",shadow:false,draggable:false,frame:false,closable:false,resizable:false,layout:"column",manager:winGroupMgr,items:[],listeners:{show:function(){}}});var sliderbaritem_hei=(snd_hei-9)/10;if(Ext.isIE7){sliderbaritem_hei-=6}function addSliderBarItem(f){var d=new Ext.Button({id:"sb_"+f,text:"用户名",width:150,height:sliderbaritem_hei,style:"border:0px solid #aaa;margin-bottom: 1px",cls:"sliderbartab",clickcount:0,listeners:{beforerender:function(){},afterrender:function(){var h=this.getEl().query("*[class=x-btn-mc]");h[0].setAttribute("style","vertical-align:top;text-align:left;padding-left:10px");var g=this.getEl().query("button");g[0].setAttribute("style","padding-left:10px;text-align:left !important;height:30px")},click:function(){Ext.getCmp(this.id).clickcount++;if(f.indexOf("tu")>=0){setSliderbarTitle(f.substr(2,f.length),false)}else{if(f.indexOf("tt")>=0){setSliderbarTeamTitle(f.substr(2,f.length),false)}}var o="Ext.getCmp('"+this.id+"').clickcount = 0;";var h=setTimeout(o,600);if(Ext.getCmp(this.id).clickcount>=2){clearTimeout(h);this.doubleclick(true)}else{var n=Ext.getCmp(f);if(n){n.showDlg()}else{if(f.indexOf("tu")>=0){SendMsgWin(f.substr(2,f.length),"")}else{if(f.indexOf("tt")>=0){for(var g=0;g<sliderbarItems_arr.length;g++){var k=sliderbarItems_arr[g];var m=k.team_id;if(m==f.substr(2,f.length)){var l=k.team_creator;var j=k.team_name;SendTeamMsgWin(m,j,"",l);break}}}}}}}},doubleclick:function(l){Ext.getCmp(this.id).clickcount=0;doubleclicked=f;if(sliderbar){for(var j=0;j<sliderbar.items.items.length;j++){var p=sliderbar.items.items[j];if(p.id==this.id){if(l){if(j+1<sliderbar.items.items.length){var g=sliderbar.items.items[j+1].id;var n=Ext.getCmp(g.substr(3,g.length));if(n){n.showDlg()}else{if(g.indexOf("tu")>=0){SendMsgWin(g.substr(5,g.length),"")}else{if(g.indexOf("tt")>=0){for(var j=0;j<sliderbarItems_arr.length;j++){var m=sliderbarItems_arr[j];var h=m.team_id;if(h==g.substr(5,g.length)){var k=m.team_creator;var o=m.team_name;SendTeamMsgWin(h,o,"",k);break}}}}}}else{if(sliderbar.items.items.length-2>=0){var g=sliderbar.items.items[sliderbar.items.items.length-2].id;var n=Ext.getCmp(g.substr(3,g.length));if(n){n.showDlg()}else{if(g.indexOf("tu")>=0){SendMsgWin(g.substr(5,g.length),"")}else{if(g.indexOf("tt")>=0){for(var j=0;j<sliderbarItems_arr.length;j++){var m=sliderbarItems_arr[j];var h=m.team_id;if(h==g.substr(5,g.length)){var k=m.team_creator;var o=m.team_name;SendTeamMsgWin(h,o,"",k);break}}}}}}}}sliderbar.items.items.splice(j,1);p.hide();var n=Ext.getCmp(f);if(n){if(f.indexOf("tu")>=0){n.closeHispnl()}n.close()}break}}sliderbar.doLayout();if(sliderbar.items.items.length==1){sliderbar.hide()}}deleteSendMsgWinId(f)}});if(sliderbar){var c=0;for(;c<sliderbar.items.items.length;c++){var a=sliderbar.items.items[c].id;if(a==("sb_"+f)){sliderbar.items.items[c].destroy();break}}if(c<sliderbar.items.items.length){sliderbar.items.items.splice(c,1,d)}else{if(sliderbar.items.items.length==10){var b=sliderbar.items.items[9];sliderbar.items.items.splice(0,0,d);if(b!=undefined&&b!=null){b.doubleclick(false)}}else{sliderbar.items.items.splice(0,0,d)}}sliderbar.doLayout()}if(sliderbar.hidden&&sendMsgWin_arr.length>=2){sliderbar.show();var e=Ext.getCmp(current_winid);if(e){sliderbar.alignTo(current_winid,"tr-tl",[0,0])}}}function setSliderbarTitle(f,e){var g;var n;var c="";var k="";var a="";var j="";for(var h=0;h<sliderbarItems_arr.length;h++){var o=sliderbarItems_arr[h];var b=o.acc_id;if(b==f){c=o.chnname;k=o.online;a=o.picurl;j=o.username}}var p="<div style='padding-top:6px'><img src='./chatjs/icons/dian.png' width=15 height=15 /></div>";if(k=="o"){g="./chatjs/icons/online-avatar.jpg";n="<div class=icobd style=width:40px;height:40px;position:relative;>"}else{g="./images/default.png";n="<div class=icobd style=width:40px;height:40px;position:relative;>"}if(a!=null&&a!=""&&a!="input"&&a!=WEB_ROOT){g=a}if(!e){p=""}var l="<table>";if(Ext.isIE7){l="<table style='margin:-10px 0px 0px -20px'>"}var m=l+"<tr><td colspan=1>"+n+"<a href='./"+j+"' target='blank'/><img onError=\"this.src='http://www.scholat.com/chatjs/icons/online-avatar.jpg'\" src="+g+" width=33 height=33 title='访问 "+c+" 的学者主页' style='vertical-align:middle'/></div></td><td><div style=padding-top:5px;font-size:12px;color:black;width:80px;height:30px;line-height:30px;text-overflow:ellipsis;overflow:hidden;>"+c+"</div></td><td>"+p+"</td></tr></table>";var d=Ext.getCmp("sb_tu"+f);if(d){d.setText(m)}}function sendwinAnchorCallBack(){var a=Ext.getCmp("sliderbar");if(current_winid!=""&&a&&a.hidden==false){a.alignTo(current_winid,"tr-tl",[0,0])}}function setSliderbarTeamTitle(c,b){var d="./chatjs/icons/team.png";var h="<div class=icobd style=width:40px;height:40px;position:relative;>";var j="";for(var e=0;e<sliderbarItems_arr.length;e++){var l=sliderbarItems_arr[e];var k=l.team_id;if(k==c){j=l.team_name}}var m="<div style='padding-top:6px'><img src='./chatjs/icons/dian.png' width=15 height=15 /></div>";if(!b){m=""}var f="<table>";if(Ext.isIE7){f="<table style='margin:-10px 0px 0px -20px'>"}var g=f+"<tr><td colspan=1>"+h+"<a href='./"+j+"' target='blank'/><img onError=\"this.src='http://www.scholat.com/chatjs/icons/online-avatar.jpg'\" src="+d+" width=33 height=33 style='vertical-align:middle'/></div></td><td><div style=padding-top:5px;font-size:12px;color:black;width:80px;height:30px;line-height:30px;text-overflow:ellipsis;overflow:hidden;white-space:nowrap; title='"+j+"'>"+j+"</div></td><td>"+m+"</td></tr></table>";var a=Ext.getCmp("sb_tt"+c);if(a){a.setText(g)}}function closeBtnClick(){if(sliderbar){sliderbar.hide()}for(var a=0;a<sendMsgWin_arr.length;a++){var b=Ext.getCmp(sendMsgWin_arr[a]);if(b){b.destroy()}}current_winid=""}var SendMsgWin=function(u,m){var r=0;var d="";var t="";var f="";var s="tu"+u;var n=false;var e=0;var q=0;var v;var o;var i=Ext.getCmp("mainwin").getChnById(u);if(m==""){var k=new Date().format("H:i");m="<table width=94% align=right><tr><th colspan=3><div align=center>"+k+"</div></th></tr></table>"}if(m.indexOf("[ToAddIcon]")>-1){var k=new Date().format("H:i");m=m.replace("[ToAddIcon]","");m=revstr1+k+revstr2+i+revstr3+"images/chatm.png"+revstr4+prcsemo(m)+revstr5}m=prcsemo(m);if(checkwin(s)==false){CHAT_WIN_ARR[CHAT_WIN_ARR.length]=s}function b(){var y=new Date();var w=y.getTime();var z=w-LAST_SEND_TIME;var x=Ext.getCmp(s+"em");backtitle();var A=x.getValue().Trim();if(A==null||A==""||A=="\n"||A=="\r"||A=="\r\n"){x.setValue("")}else{if(A.length>1500){tipsbox.msg("发送内容超长","请分条发送",0.5,x.getEl(),"t-t")}else{if((z<3000&&LAST_SEND_TIME!=0)||(z<5000&&LAST_SEND_TIME==0)){tipsbox.msg("发送消息间隔太短","请您稍等片刻继续发送",3,x.getEl(),"t-t");return}LAST_SEND_TIME=w;Ext.getCmp(s).sendMsg();x.setValue("")}}}function j(){insertAtCursor(Ext.getCmp(s+"em"),"\n")}function a(y,x){Ext.MessageBox.confirm("&nbsp;&nbsp;您确认分享以下文件？","<br>["+y+"]<br>",function w(z){if(z=="yes"){var A=new Date().format("YmdHis");ChatMng.sharefile(ACCOUNT_ID,CHINESE_NAME,FILE_SHARE_ID,x,y,A)}else{tipsbox.msg("取消分享",y,0.5,FSHARE_WIN.getEl(),"t-t")}})}function l(){var w=o.root.childNodes;var y;for(var x=0;x<w.length;x++){y=w[x];y.setTooltip(y.text);y.setText(y.text);if(y.leaf==true){y.getUI().getIconEl().src=WEB_ROOT+"images/homepage/style1/page.gif"}}}function p(){Ext.getCmp("emowin").hide();var w=new Ext.data.JsonStore({id:"HisStore",autoLoad:true,proxy:new Ext.data.HttpProxy({url:"./SeekUserHisActionForChat.html?cur_acc_id="+ACCOUNT_ID+"&op_acc_id="+u}),fields:["msg"]});w.on("load",function(){var x=w.getAt(0);if(x!=null){var y=prcsemo(x.get("msg"))}else{y=""}v=y;Ext.getCmp(s).setWidth(595);Ext.getCmp(s+"btnhis").setText("&nbsp;关闭记录");n=true;if(v.length<2*PER_PAGE_WORDS){q=1}else{q=parseInt(v.length/PER_PAGE_WORDS)+1}e=q;g()})}function g(){Ext.getCmp(s+"hispnl").setTitle("&nbsp;消息记录 [第"+e+"页，共"+q+"页]");if(q<2){Ext.getCmp(s+"hispnl").body.update(v)}else{var w=v.substring((e-1)*PER_PAGE_WORDS-200,e*PER_PAGE_WORDS);var y=w.indexOf("<div style=color");var x=w.lastIndexOf("<div style=color");if(y<0){y=0}if(e==q){x=w.length}w=w.substring(y,x);Ext.getCmp(s+"hispnl").body.update(w)}Ext.getCmp(s+"hispnl").setVisible(true)}if(SEND_DLG_LEFT<300&&SEND_DLG_TOP<220){SEND_DLG_LEFT=SEND_DLG_LEFT+30;SEND_DLG_TOP=SEND_DLG_TOP+30}else{SEND_DLG_LEFT=START_LEFT;SEND_DLG_TOP=START_TOP}var c=new Ext.Window({id:s,title:expdlgtitle(i,r,d,t,f),width:send_wid,height:snd_hei,x:page_width-send_wid-180,y:0,modal:false,resizable:false,layout:"column",shadow:false,style:"position:fixed;border:1px solid #aaa",minimizable:false,hideMode:"offsets",iconCls:"main",draggable:false,bodyStyle:"background-color:#f6f6f6",listeners:{beforeclose:function(){if(sendMsgWin_arr.length<=1&&doubleclicked==""){backtitle();closeemohiswin();Ext.getCmp(s).destroy();if(CHAT_LOGIN){delwin(s)}var w=sliderbar.items.items.pop();w.hide();if(sliderbar){sliderbar.hide()}deleteSendMsgWinId(s);current_winid=""}else{if(doubleclicked==""){Ext.getCmp(s).closeHispnl();closeBtnClick()}else{backtitle();closeemohiswin();Ext.getCmp(doubleclicked).destroy();if(CHAT_LOGIN){delwin(doubleclicked)}doubleclicked="";current_winid="";deleteSendMsgWinId(s);if(sliderbar.items.items.length==1){sliderbar.hide()}}}},beforeshow:function(){},show:function(){var w=hasIdInSendMsgWinArr(s);if(w==-1){sendMsgWin_arr.push(s)}},move:function(){window.scrollTo(0,0)},resize:function(){this.alignTo("mainwin","tr-tl",[0,0]);if(sliderbar&&sliderbar.hidden==false){sliderbar.alignTo(s,"tr-tl",[0,0])}}},keys:[{key:Ext.EventObject.ENTER,fn:b,ctrl:false,scope:this},{key:Ext.EventObject.ENTER,fn:j,ctrl:true,scope:this}],items:[{width:396,style:"background-color:#dceeee",items:[{id:s+"mm",region:"center",style:"font-size:12px;background-position: right bottom; ",border:0,height:mm_hei-10,width:394,html:m,xtype:"panel",layout:"fit",autoScroll:true,bodyStyle:mm_style},{xtype:"textarea",enableKeyEvents:true,id:s+"em",width:394,height:67,listeners:{focus:closeemohiswin}}],buttons:[{text:"",iconCls:"emo",id:s+"sbtn",tooltip:"插入表情",handler:function(){if(!EMO_WIN.hidden){EMO_WIN.hide();return}EMOID=s;EMO_WIN.show();EMO_WIN.alignTo(Ext.getCmp(s+"sbtn").getEl(),"b-t",[0,0])}},{text:"",iconCls:"fsend",id:s+"fsbtn",tooltip:"发送我的本地文件",handler:function(){if(!EMO_WIN.hidden){EMO_WIN.hide();return}if(Ext.getCmp("fsenddlg")){Ext.getCmp("fsenddlg").close()}SEND_FILE_NAME=i;SEND_FILE_ACCID=u;var y=true;if(navigator.userAgent.indexOf("MSIE")>0){var x=navigator.userAgent.indexOf("MSIE 10.0");if(x==-1){y=false}}if(y){var z=new Date().format("YmdHis");var A=ACCOUNT_ID+"<filesp>"+SEND_FILE_ACCID+"<filesp>"+z;showFileSend({win_id:s,allowedExtensions:"",url:"./uploadFiles.html?path="+A})}else{var w=showfilesend();w.show();w.on("deactivate",function(){this.setZIndex(99998)});w.alignTo(Ext.getCmp(s).getEl(),"c-c",[0,0])}}},{text:"&nbsp;消息记录",id:s+"btnhis",tooltip:"显示消息记录",handler:function(){if(n){Ext.getCmp(s+"hispnl").setVisible(false);Ext.getCmp(s).setWidth(send_wid);Ext.getCmp(s+"hispnl").body.update("");Ext.getCmp(s+"btnhis").setText("&nbsp;消息记录");n=false;return}p()}},{text:"关闭(Esc)",tooltip:"按Esc键\n关闭对话窗口",handler:function(){doubleclicked=s;var w=Ext.getCmp("sb_"+s);if(w){w.doubleclick(true)}}},{text:"发送(Enter)",id:s+"bts",tooltip:"按Enter键发送消息，\n按Ctrl+Enter键换行",handler:b}]},{title:"&nbsp;消息记录",id:s+"hispnl",xtype:"panel",height:his_hei,width:194,autoScroll:true,bodyStyle:"padding:10px;background-color:#fff;word-break:break-all;",buttons:[{text:"清除记录",handler:function(){ChatMng.delhis(ACCOUNT_ID,u,"user");Ext.getCmp(s+"hispnl").body.update("");Ext.getCmp(s+"hispnl").setTitle("&nbsp;消息记录 [已清除]")}},{text:"",iconCls:"pppre",handler:function(){if(e>1){e--;g()}else{tipsbox.msg("消息记录","已经是第一页",1,Ext.getCmp(s+"hispnl").getEl(),"t-t")}}},{text:"",iconCls:"ppnext",handler:function(){if(e<q){e++;g()}else{tipsbox.msg("消息记录","已经是最后一页",1,Ext.getCmp(s+"hispnl").getEl(),"t-t")}}}]}],getPicUrl:function(){return d},showDlg:function(){this.show();if(needSendOff!=2&&newMsg_arr.length>0){needSendOff=0}for(var z=0;z<newMsg_arr.length;z+=1){var E=newMsg_arr[z];if(E!=undefined){var w=E.from_acc_id;if(w){var C=false;if("tu"+w==this.id){var y=E.from_chnname;var x=E.msg;var D=E.radnum;var A=E.seal;showoff();newMsg_arr.splice(z,1);z--}}}}if(current_winid!=""&&current_winid!=this.id){var B=Ext.getCmp(current_winid);if(B){B.closeHispnl();B.hide()}}current_winid=this.id;if(sliderbar&&sliderbar.hidden==false){setTimeout(function(){if(Ext.getCmp(s)){Ext.getCmp(s).getEl().anchorTo(document,"tr-tr",[-277,40],false,true,sendwinAnchorCallBack);sliderbar.alignTo(s,"tr-tl",[0,0])}},100)}},sendMsg:function(){var x;if(Ext.getCmp(s).title.indexOf("offline")<0){x=true}else{x==false}var y=s+"mm";var w=s+"em";var z=Ext.getCmp(w).getValue();if(ACCOUNT_ID!="12"){z=htmlrep(z);if(z.substr(0,4)=="<br>"){z=z.substr(4,z.length)}}if(z.length<2500){if(x==true){ChatMng.send(CHINESE_NAME,u,i,z)}else{ChatMng.sendoff(CHINESE_NAME,u,i,z)}showsendmsg(y,w)}else{tipsbox.msg("发送消息内容超长","请分条发送",0.5,wcmp.getEl(),"t-t")}},closeHispnl:function(){if(n){Ext.getCmp(s+"hispnl").setVisible(false);Ext.getCmp(s).setWidth(send_wid);Ext.getCmp(s+"hispnl").body.update("");Ext.getCmp(s+"btnhis").setText("&nbsp;消息记录");n=false}}});Ext.getCmp(s).showDlg();Ext.getCmp(s).alignTo(document,"tr-tr",[-277,40]);Ext.getCmp(s).getEl().anchorTo(document,"tr-tr",[-277,40],false,true,sendwinAnchorCallBack);Ext.getCmp(s+"em").focus("",250);Ext.getCmp(s+"hispnl").setVisible(false);var h=new Ext.data.JsonStore({id:"InfoStore",autoLoad:true,proxy:new Ext.data.HttpProxy({url:"./SeekUserInfoActionForChat.html?acc_id="+u}),fields:["picurl","mtitle","online","name","user"]});h.on("load",function(){var A=h.getAt(0);var y;var H;var C;if(A!=null){d=WEB_ROOT+A.get("picurl");t=A.get("mtitle");r=A.get("online");i=A.get("name");f=A.get("user");Ext.getCmp("tu"+u).setTitle(expdlgtitle(i,r,d,t,f));var E=u+"";var F={acc_id:u,chnname:i,online:r,picurl:d,username:f};for(var z=0;z<sliderbarItems_arr.length;z++){var G=sliderbarItems_arr[z];var x=G.acc_id;if(x==E){sliderbarItems_arr.splice(z,1);break}}sliderbarItems_arr.push(F);addSliderBarItem(s);setSliderbarTitle(u,false);var D=Ext.getCmp(s+"mm");var B=D.body.dom;var w=B.innerHTML;w=w.replace(/\images\/chatm.png/g,d);w=w.replace("http://www.scholat.com//images/default.png",d);D.body.update(w)}})};
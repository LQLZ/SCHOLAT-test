var SendTeamMsgWin=function(c,k,n,s){var w="tt"+c;var t=false;var d=0;var v=0;var x;var i=372;if(Ext.isIE7){i=363}n=prcsemo(n);if(checkwin(w)==false){CHAT_WIN_ARR[CHAT_WIN_ARR.length]=w}if(n==""){var m=new Date().format("H:i");n="<table width=94% align=right><tr><th colspan=3><div align=center>"+m+"</div></th></tr></table>"}else{if(n.indexOf("[ToAddIcon]")>-1){var m=new Date().format("H:i");n=n.replace("[ToAddIcon]","");n="<table width=94% align=right><tr><th colspan=3><div align=center>"+m+"</div></th></tr></table>"+n}}function a(){backtitle();var A=new Date();var y=A.getTime();var B=y-LAST_SEND_TIME;var z=Ext.getCmp(w+"em");var C=z.getValue().Trim();if(C==null||C==""||C=="\n"||C=="\r"||C=="\r\n"){z.setValue("")}else{if(z.getValue().length>1500){tipsbox.msg("发送内容超长","请分条发送",0.5,z.getEl(),"t-t")}else{if((B<3000&&LAST_SEND_TIME!=0)||(B<5000&&LAST_SEND_TIME==0)){tipsbox.msg("发送消息间隔太短","请您稍等片刻继续发送",3,z.getEl(),"t-t");return}LAST_SEND_TIME=y;Ext.getCmp(w).sendMsg()}}}function l(){insertAtCursor(Ext.getCmp(w+"em"),"\n")}function f(){Ext.getCmp("hispnl"+c).setTitle("&nbsp;消息记录 [第"+d+"页，共"+v+"页]");if(v<2){Ext.getCmp("hispnl"+c).body.update(x)}else{var y=x.substring((d-1)*PER_PAGE_WORDS-200,d*PER_PAGE_WORDS);var A=y.indexOf("<div style=color");var z=y.lastIndexOf("<div style=color");if(A<0){A=0}if(d==v){z=y.length}y=y.substring(A,z);Ext.getCmp("hispnl"+c).body.update(y)}}var q=new Ext.tree.AsyncTreeNode({text:"成员"});var g=new Ext.tree.TreePanel({root:q,id:"mem"+c,height:334,width:140,rootVisible:false,lines:false,enableDD:false,animate:true,loader:new Ext.tree.TreeLoader({dataUrl:"./MemTreeActionForChat.html?acc_id="+ACCOUNT_ID+"&team_id="+c}),title:"&nbsp;成员",listeners:{expandnode:function(y){h()},afterrender:function(){var z=this.getEl().select("div.x-panel-body");var y="307px";if(Ext.isIE7){y="297px"}z.elements[0].style.height=y}},autoScroll:true,border:true,bodyStyle:"background-color:#fff"});var p=new Ext.Panel({title:"&nbsp;消息记录",id:"hispnl"+c,xtype:"panel",height:i,width:194,autoScroll:true,bodyStyle:"padding:10px;background-color:#fff;word-break:break-all;",buttons:[{text:"清除记录",handler:function(){if(s=="nodel"){tipsbox.msg("临时团队对话","无法删除团队消息",1,Ext.getCmp("hispnl"+c).getEl(),"t-t");return}if(s!=ACCOUNT_ID){tipsbox.msg("您没有权限","只有创建者才可以删除团队消息",1,Ext.getCmp("hispnl"+c).getEl(),"t-t");return}Ext.getCmp("hispnl"+c).setTitle("&nbsp;消息记录 [已清除]");ChatMng.delhis(ACCOUNT_ID,c,"team");Ext.getCmp("hispnl"+c).body.update("")}},{text:"",iconCls:"pppre",handler:function(){if(d>1){d--;f()}else{tipsbox.msg("消息记录","已经是第一页",1,Ext.getCmp("hispnl"+c).getEl(),"t-t")}}},{text:"",iconCls:"ppnext",handler:function(){if(d<v){d++;f()}else{tipsbox.msg("消息记录","已经是最后一页",1,Ext.getCmp("hispnl"+c).getEl(),"t-t")}}}]});var h=function(){var y=g.root.childNodes;var A=0;var B;for(var z=0;z<y.length;z++){B=y[z];B.setText(getstrbylen(B.text,8));if(B.attributes.ol=="o"){url=B.attributes.url;if(url==""||url==null||url=="url"||url=="/images/default.png"){url="/chatjs/icons/online-avatar.jpg"}B.getUI().getIconEl().src=WEB_ROOT+url;A++}}Ext.getCmp("mem"+c).setTitle("&nbsp;团队成员 ["+A+"/"+y.length+"]")};var r="padding:4px 12px 6px 12px;background-color:#dceeee";var e=80;if(Ext.isIE7){r="padding:13px 8px 6px 8px;background-color:#dceeee";e=82}var o=new Ext.Panel({region:"center",width:394,style:"background-color:#339999",items:[{id:w+"mm",region:"center",style:"font-size:12px",border:0,height:256,width:394,html:n,xtype:"panel",layout:"fit",autoScroll:true,bodyStyle:r},{xtype:"textarea",id:w+"em",width:394,height:e,listeners:{focus:closeemohiswin}}],buttons:[{text:"",iconCls:"emo",id:w+"tbtn",tooltip:"插入表情",handler:function(){if(!EMO_WIN.hidden){EMO_WIN.hide();return}EMOID=w;EMO_WIN.show();EMO_WIN.alignTo(Ext.getCmp(w+"tbtn").getEl(),"b-t",[0,0])}},{text:"&nbsp;消息记录",id:w+"btnhis",tooltip:"显示消息记录",handler:function(){Ext.getCmp("emowin").hide();if(t){Ext.getCmp("hispnl"+c).setVisible(false);Ext.getCmp("mem"+c).setVisible(true);Ext.getCmp(w+"box").setWidth(140);Ext.getCmp(w).setWidth(540);Ext.getCmp("hispnl"+c).body.update("");Ext.getCmp(w+"btnhis").setText("&nbsp;消息记录");t=false}else{var y=new Ext.data.JsonStore({id:"HisStore",autoLoad:true,proxy:new Ext.data.HttpProxy({url:"./SeekTeamHisActionForChat.html?acc_id="+ACCOUNT_ID+"&team_id="+c}),fields:["msg"]});y.on("load",function(){var z=y.getAt(0);if(z!=null){var A=prcsemo(z.get("msg"))}else{A=""}x=A;if(x.length<2*PER_PAGE_WORDS){v=1}else{v=parseInt(x.length/PER_PAGE_WORDS)+1}d=v;Ext.getCmp("mem"+c).setVisible(false);Ext.getCmp("hispnl"+c).setVisible(true);Ext.getCmp(w+"box").setWidth(194);Ext.getCmp(w).setWidth(594);Ext.getCmp(w+"btnhis").setText("&nbsp;成员列表");t=true;f()})}}},{text:"关闭(Esc)",tooltip:"按Esc键\n关闭对话窗口",handler:function(){doubleclicked=w;var y=Ext.getCmp("sb_"+w);if(y){y.doubleclick(true)}}},{text:"发送(Enter)",id:w+"bts",tooltip:"按Enter键发送消息，\n按Ctrl+Enter键换行",handler:a}]});var u=new Ext.Panel({region:"east",id:w+"box",width:141,style:"border:0",margins:"0 0 0 0",border:false,cmargins:"0 0 0 0",items:[g,p]});var j=function(z,A){LAST_SEND_TIME=0;var y=Ext.getCmp("tu"+z.id);if(!y){showsendwin(z.id,"")}else{y.show()}};g.on("click",j);if(SEND_DLG_LEFT<300&&SEND_DLG_TOP<220){SEND_DLG_LEFT=SEND_DLG_LEFT+30;SEND_DLG_TOP=SEND_DLG_TOP+30}else{SEND_DLG_LEFT=START_LEFT;SEND_DLG_TOP=START_TOP}var b=new Ext.Window({id:w,title:"<div  title="+k+" class=icobd style='font-size:16px;font-weight:blod;color:white;margin-bottom:4px;width:380px;display: block;word-break: keep-all; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;'><a target=blank href=./teamIndex.html?teamId="+c+"><img src=./chatjs/icons/team.png width=54 height=54 style='border:1px #aaa solid;vertical-align:text-bottom;'/></a>&nbsp;&nbsp;"+k+"</div>",width:540,height:snd_hei,x:SEND_DLG_LEFT,y:SEND_DLG_TOP,modal:false,layout:"border",resizable:false,shadow:false,maximizable:false,hideMode:"offsets",style:"position:fixed;border:1px solid #aaa",iconCls:"main",items:[o,u],bodyStyle:"background-color:#f6f6f6",draggable:false,listeners:{beforeclose:function(){if(sendMsgWin_arr.length<=1&&doubleclicked==""){backtitle();closeemohiswin();Ext.getCmp(w).destroy();if(CHAT_LOGIN){delwin(w)}var y=sliderbar.items.items.pop();y.hide();if(sliderbar){sliderbar.hide()}deleteSendMsgWinId(w);current_winid=""}else{if(doubleclicked==""){closeBtnClick()}else{backtitle();closeemohiswin();Ext.getCmp(doubleclicked).destroy();if(CHAT_LOGIN){delwin(doubleclicked)}doubleclicked="";current_winid="";deleteSendMsgWinId(w);if(sliderbar.items.items.length==1){sliderbar.hide()}}}},show:function(){Ext.getCmp("hispnl"+c).setVisible(false);Ext.getCmp(w).setWidth(540);Ext.getCmp(w).updateMem();jsonObj={team_id:c,team_name:k,team_creator:s};sliderbarItems_arr.push(jsonObj);var y=hasIdInSendMsgWinArr(w);if(y==-1){sendMsgWin_arr.push(w)}addSliderBarItem(w);setSliderbarTeamTitle(c,false)},move:function(){window.scrollTo(0,0)},resize:function(){this.alignTo("mainwin","tr-tl",[0,0]);if(sliderbar&&sliderbar.hidden==false){sliderbar.alignTo(w,"tr-tl",[0,0])}}},keys:[{key:Ext.EventObject.ENTER,fn:a,ctrl:false,scope:this},{key:Ext.EventObject.ENTER,fn:l,ctrl:true,scope:this}],showDlg:function(){if(needTeamSendOff!=2&&newTeamMsg_arr.length>0){needTeamSendOff=0}this.show();for(var A=0;A<newTeamMsg_arr.length;A++){var B=newTeamMsg_arr[A];if(B!=null&&B!=undefined){var z=B.team_id;if(z&&"tt"+z==this.id){var F=B.msg;var C=B.seal;var y=Ext.getCmp("tt"+z+"mm").body;var E=y.dom;F=E.innerHTML+F;y.update(F);E.scrollTop=E.scrollHeight-E.offsetHeight;newTeamMsg_arr.splice(A,1);A--;ChatMng.remseal(C)}}}if(current_winid!=""&&current_winid!=this.id){var D=Ext.getCmp(current_winid);if(D){D.closeHispnl();D.hide()}}current_winid=w;if(sliderbar&&sliderbar.hidden==false){setTimeout(function(){if(Ext.getCmp(w)){sliderbar.alignTo(w,"tr-tl",[0,0])}},100)}},sendMsg:function(){var A=w+"mm";var y=w+"em";var B=Ext.getCmp(w+"em").getValue();B=htmlrep(B);if(B.substr(0,4)=="<br>"){B=B.substr(4,B.length)}var z=new Date().format("H:i");ChatMng.teamsend(ACCOUNT_ID,CHINESE_NAME,c,k,B);showsendmsg(A,y)},updateMem:function(){g.root.reload()},getMemNode:function(y){return g.getNodeById(y)},closeHispnl:function(){if(t){Ext.getCmp("hispnl"+c).setVisible(false);Ext.getCmp("mem"+c).setVisible(true);Ext.getCmp(w+"box").setWidth(140);Ext.getCmp(w).setWidth(540);Ext.getCmp("hispnl"+c).body.update("");Ext.getCmp(w+"btnhis").setText("&nbsp;消息记录");t=false}}});b.showDlg();b.alignTo("mainwin","tr-tl",[0,0]);b.getEl().anchorTo(document,"tr-tr",[-277,40],false,true,sendwinAnchorCallBack);Ext.getCmp(w+"em").focus("",250)};
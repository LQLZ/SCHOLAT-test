Date.prototype.getElapsed=function(a){return Math.abs((a||new Date()).getTime()-this.getTime())};var nowFilename;var sendtime;UploadDialog=Ext.extend(Ext.Window,{swfupload:null,progressBar:null,progressInfo:null,uploadInfoPanel:null,constructor:function(a){this.progressInfo={bytesTotal:0,bytesUploaded:0,currentCompleteBytes:0,lastBytes:0,lastElapsed:1,lastUpdate:null,timeElapsed:1};this.uploadInfoPanel=new Ext.Panel({region:"north",height:40,baseCls:"",border:false});this.progressBar=new Ext.ProgressBar({text:"等待发送中 0 %"});this.uploadInfoPanel.on("render",function(){this.getProgressTemplate().overwrite(this.uploadInfoPanel.body,{bytesUploaded:"0 B",bytesTotal:"0 B",speedLast:"0 B/S"})},this);UploadDialog.superclass.constructor.call(this,Ext.applyIf(a||{},{title:"发送文件给 ["+SEND_FILE_NAME+"]",resizable:false,id:"fsenddlg",closable:false,closeAction:"close",layout:"border",iconCls:"sendfile",style:"position:fixed;border:2px #ddd solid",shadow:false,width:300,height:180,bbar:[{text:"&nbsp;&nbsp;关闭&nbsp;&nbsp;",handler:function(){this.stopUpload();this.close()},scope:this}],tbar:[],listeners:{move:function(){window.scrollTo(0,0)},show:function(){this.getTopToolbar().add(this.progressBar);var b={upload_url:this.uploadUrl,post_params:Ext.isEmpty(this.postParams)?{}:this.postParams,flash_url:Ext.isEmpty(this.flashUrl)?"http://www.swfupload.org/swfupload.swf":this.flashUrl,file_post_name:Ext.isEmpty(this.filePostName)?"myUpload":this.filePostName,file_size_limit:Ext.isEmpty(this.fileSize)?"100 MB":this.fileSize,file_upload_limit:1,file_types:Ext.isEmpty(this.fileTypes)?"*.*":this.fileTypes,file_types_description:this.fileTypesDescription,use_query_string:true,debug:false,button_placeholder_id:"select-button",button_width:300,button_text_top_padding:3,button_height:25,button_text:'<span class="select-button">[点击此处选择文件，不大于100MB]</span>',button_text_style:".select-button {text-align: center;line-height: 10px;text-decoration:underline;color:#ff0000;}",button_action:SWFUpload.BUTTON_ACTION.SELECT_FILES,button_disabled:false,button_cursor:SWFUpload.CURSOR.HAND,button_window_mode:SWFUpload.WINDOW_MODE.OPAQUE,custom_settings:{scope_handler:this},file_queued_handler:this.onFileQueued,file_queue_error_handler:this.onFileQueueError,file_dialog_complete_handler:this.onFileDialogComplete,upload_start_handler:this.onUploadStart,upload_progress_handler:this.onUploadProgress,upload_error_handler:this.onUploadError,upload_success_handler:this.onUploadSuccess,upload_complete_handler:this.onUploadComplete};this.swfupload=new SWFUpload(b);this.swfupload.uploadStopped=false;Ext.get(this.swfupload.movieName).setStyle({position:"absolute",top:0,left:-2});this.resizeProgressBar();this.on("resize",this.resizeProgressBar,this)}},items:[this.uploadInfoPanel,{region:"center",layout:"fit",margins:"0 -1 0 -1",id:"filenamepnl",html:"",bbar:{text:"选择文件",id:"select-button"}}]}))},resizeProgressBar:function(){this.progressBar.setWidth(this.el.getWidth()-10)},startUpload:function(){if(this.swfupload){sendtime=new Date().format("YmdHis");var a=this.swfupload.settings.post_params;a.path=ACCOUNT_ID+"<filesp>"+SEND_FILE_ACCID+"<filesp>"+sendtime;this.swfupload.setPostParams(a);this.swfupload.uploadStopped=false;this.swfupload.startUpload()}},stopUpload:function(){if(this.swfupload){this.swfupload.uploadStopped=true;this.swfupload.stopUpload()}},getProgressTemplate:function(){var a=new Ext.Template('<table class="upload-progress-table"><tbody><tr>','<td class="upload-progress-value"><nobr>&nbsp;&nbsp;&nbsp;&nbsp;{speedLast}</nobr></td>','</tr><tr><td class="upload-progress-value"><nobr>&nbsp;&nbsp;&nbsp;&nbsp;{bytesUploaded} / {bytesTotal}</nobr></td></tr>','</tr><tr><td class="upload-progress-value" ><nobr>{fileName}</nobr></td></tr>',"</tbody></table>");a.compile();return a},updateProgressInfo:function(){this.getProgressTemplate().overwrite(this.uploadInfoPanel.body,this.formatProgress(this.progressInfo))},formatProgress:function(d){var b={};b.bytesUploaded=String.leftPad(Ext.util.Format.fileSize(d.bytesUploaded),6,"&#160;");b.bytesTotal=Ext.util.Format.fileSize(d.bytesTotal);b.fileName=getstrbylen(nowFilename,20);var a=1000*d.lastBytes/d.lastElapsed;b.speedLast=Ext.util.Format.fileSize(a<0?0:a)+"/S";var c=d.bytesUploaded/d.bytesTotal;c=c||0;this.progressBar.updateProgress(c,"上传中 "+Math.ceil(c*100)+" %");return b},onClose:function(){this.close()},onFileQueued:function(a){nowFilename=a.name;var b=this.customSettings.scope_handler;b.progressInfo.bytesTotal=a.size;b.updateProgressInfo()},onQueueError:function(b,e,d){var c=this.customSettings.scope_handler;try{if(e!=SWFUpload.UPLOAD_ERROR.UPLOAD_STOPPED){c.progressInfo.filesTotal-=1;c.progressInfo.bytesTotal-=b.size}c.progressInfo.bytesUploaded-=fpg.getBytesCompleted();c.updateProgressInfo()}catch(a){this.debug(a)}},onFileDialogComplete:function(a,b){setTimeout('Ext.getCmp("fsenddlg").startUpload()',1000)},onUploadProgress:function(a,f,e){var d=Math.ceil((f/e)*100);var b=this.customSettings.scope_handler;var c=f-b.progressInfo.currentCompleteBytes;b.progressInfo.bytesUploaded+=Math.abs(c<0?0:c);b.progressInfo.currentCompleteBytes=f;if(b.progressInfo.lastUpdate){b.progressInfo.lastElapsed=b.progressInfo.lastUpdate.getElapsed();b.progressInfo.timeElapsed+=b.progressInfo.lastElapsed}b.progressInfo.lastBytes=c;b.progressInfo.lastUpdate=new Date();b.updateProgressInfo()},onUploadError:function(a,c,b){if(Ext.getCmp("fsenddlg")){Ext.getCmp("fsenddlg").close()}tipsbox.msg("文件发送失败","错误原因:"+b,5)},onUploadSuccess:function(b,a){if(Ext.getCmp("fsenddlg")){Ext.getCmp("fsenddlg").close()}tipsbox.msg("文件发送成功","服务器将为您保存30天",5);ChatMng.sendfile(SEND_FILE_ACCID)}});UploadDialog.FileRecord=Ext.data.Record.create([{name:"fileId"},{name:"fileName"},{name:"fileSize"},{name:"fileType"},{name:"fileState"}]);